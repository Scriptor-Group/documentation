name: Changelog notification

on:
  push:
    paths:
      - "changelogs/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Mattermost Notification
        env:
          WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail
          
          WEBHOOK="$(printf '%s' "${WEBHOOK:-}" | tr -d '\r\n\t ')"
          : "${WEBHOOK:?MATTERMOST_WEBHOOK_URL est vide ou non disponible}"

          cat >payload.json <<'EOF'
          {
            "username": "GitHub Actions",
            "icon_emoji": ":bell:",
            "attachments": [
              {
                "color": "#1e90ff",
                "title": "ðŸ“ changelogs a bougÃ© !",
                "fields": [
                  { "short": true, "title": "Repo", "value": "${{ github.repository }}" },
                  { "short": true, "title": "Branch", "value": "${{ github.ref_name }}" },
                  { "short": true, "title": "Actor", "value": "${{ github.actor }}" },
                  { "short": true, "title": "Commit", "value": "${{ github.sha }}" },
                  { "short": false, "title": "", "value": "### [Voir le workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" }
                ]
              }
            ]
          }
          EOF

          curl --fail-with-body -X POST \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "$WEBHOOK"
